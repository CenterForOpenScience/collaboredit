<!DOCTYPE html>
<html>
<head>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
  <script src="http://cdn.sockjs.org/sockjs-0.3.min.js"></script>
  <script src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>


</head>
<body>
<h3>Collaborative Editor!</h3>

<style id='my_style' type="text/css" media="screen">

  div.user_1.ace_cursor {
        border-left-color: red;
  }



</style>



<div id="editor">
</div>
<div>Current User List:</div>

<script src="/static/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
      ace.require("ace/lib/fixoldbrowsers");
     var editor = ace.edit("editor");
      editor.setTheme("ace/theme/monokai");



    $(function() {
      var  conn = null;
      var  from_message = false;
      var  check1=false;
      var  check2=false;
      var check3=false;
      var check4=false;
      var applychange=false;
      var  from_cursor = false;
      var colorstack=[];
      var r=ace.require('ace/range').Range;
      var users=[];

       $(function() {
      var css = $('#my_style')[0];

      var rule1='';
      var rules = ' #editor {height: 300px; display: block; position:relative;}';
      var rule2='';

      for (var i=0; i < 100; i++){
      var a = 5*Math.floor(Math.random() * 4)
      var b = 5*Math.floor(Math.random() * 4)
      var c = 5*Math.floor(Math.random() * 4)
          while(a==0 && b==0 && c==0){
              a = 5*Math.floor(Math.random() * 4)
              b = 5*Math.floor(Math.random() * 4)
              c = 5*Math.floor(Math.random() * 4)
          }

      rule1 += 'div.user_' + String(i) + '.ace_cursor { border-left-color: #' + a.toString(16) + b.toString(16) + c.toString(16) + ' }\n'
      rule2 += 'div.ace_marker-layer div.user_' + String(i) + '.ace_selection { background-color: #' + a.toString(16) + b.toString(16) + c.toString(16)+ ' }\n'
          colorstack[i]='#' + a.toString(16) + b.toString(16) + c.toString(16);
       }

          rules=rules+rule1+rule2;

           css.innerHTML = rules;
       });

      function DynamicDiv(num,name,user_id) {
          var color="gray";
            if(user_id!=-1){
                color=colorstack[num];
            }
        var dynDiv = document.createElement("div");
        dynDiv.id = user_id;
        dynDiv.innerHTML = name;

        dynDiv.style.color =color;
        dynDiv.style.height = "20px";
        dynDiv.style.width = "60px";
        dynDiv.style.backgroundColor = 'black';
        document.body.appendChild(dynDiv);
      }

      function connect() {
        disconnect();

        conn = new SockJS('http://' + window.location.host + '/chat', "websocket");



        conn.onopen = function() {
            DynamicDiv(-1,"Myself",-1);
        };

        conn.onmessage = function(e) {
                console.log(e.data)
               var co = JSON.parse(e.data);
               if (co.act == "correction"){


                   console.log(co.info);
                   var n=JSON.parse(co.info);

                    if (n!=(editor.getValue())){

                            from_cursor=true;
                            applychange=true;
                            from_message=true;
                            check1=true;
                            check2=true;
//                            editor.setReadOnly(true);
//                         console.log("fixed")
                            var p=editor.getSelection().getCursor();

                            editor.setValue(n);



                            editor.clearSelection();
                            editor.getSelection().moveCursorToScreen(p.row, p.column,false);

//                            setTimeout(function(){editor.setReadOnly(false)},800);
                            from_message=false;
                            from_cursor=false;
                            applychange=false;


                    }
                }
                else if(co.act == "getValue"){

                   conn.send(JSON.stringify("user_0_client_text"+editor.getValue()));
                }
                else if (co.act == "create_cursor"){
//                console.log(co);
                    var row= co.row;
                    var column1= co.column;
                    var column2=column1 +1;
                    var myrange=new r(row,column1,row,column2);
                    var num=co.user_id % 100;
                    var markid=editor.session.addMarker(myrange,"user_"+num+" ace_cursor","text");
                    users[co.user_id]=markid;
                    DynamicDiv(num,co.name,co.user_id);
                }
                else if(co.act == "remove_cursor"){
//                console.log(co);
                    var markid=users[co.user_id];
                    users[co.user_id]=-1;
                    editor.session.removeMarker(markid);
                    var oldelement=document.getElementById(co.user_id);
                    if (oldelement) {
                        oldelement.parentNode.removeChild(oldelement);
                    }

                }
                else if(co.act == 'move_cursor'){
                console.log("2");
                   from_cursor=true;
                    var markid=users[co.user_id];
                    editor.session.removeMarker(markid);

                    var row= co.row;
                    var column1= co.column;
                    var column2=column1 +1;
                    var myrange=new r(row,column1,row,column2);
                    var num=co.user_id % 100;
                    var markid=editor.session.addMarker(myrange,"user_"+num+" ace_cursor","text");
                    users[co.user_id]=markid;
                   from_cursor=false;
                }
                else if(co.act == 'change_selection'){
                    var markid=users[co.user_id];
                    editor.session.removeMarker(markid);

                    var row1= co.start_row;
                    var row2= co.end_row;
                    var column1= co.start_column;
                    var column2=co.end_column;
                    var myrange=new r(row1,column1,row2,column2);
                    var num=co.user_id % 100;
                    var markid=editor.session.addMarker(myrange,"user_"+num+" ace_selection","text");
                    users[co.user_id]=markid;
                }
                else {
//                console.log(co);
                    var c= editor.getCursorPosition();

                    from_message = true;
                    if((co.range.start.row< c.row)
                        || (co.range.end.row< c.row)
                        || (co.range.start.column< c.column)
                        ||(co.range.end.column< c.column)){
                        console.log("3");
                            editor.getSession().getDocument().applyDeltas([co]);
                    }
                    else{
                        console.log("4");
                        from_cursor=true;
                        editor.getSession().getDocument().applyDeltas([co]);

                        editor.getSelection().moveCursorTo(c.row, c.column,true);
                        from_cursor=false;
                    }
                    from_message = false;
                }




        };

        conn.onclose = function() {

          conn = null;

        };



      }

      function disconnect() {
        if (conn != null) {
          conn.close();
          conn = null;
        }
      }


      $(function() {
        if (conn == null) {
          connect();
        }
        return false;
      });


       editor.getSession().getDocument().on('change', function(e){
           if(!from_message&&!applychange&&!from_cursor){


                    conn.send(JSON.stringify(e.data )+ '\r\n');

            }
       });


       editor.getSelection().on('changeCursor', function() {
            if(!from_cursor&&!applychange){

                        setTimeout(function() {

                            var oldrange=editor.getSelection().getRange();
                            if((oldrange.start.row==oldrange.end.row) && (oldrange.start.column==oldrange.end.column)){
                                conn.send(JSON.stringify(editor.getSelection().getCursor())+ '\r\n');
                            }else{

                                conn.send(JSON.stringify(editor.getSelection().getRange())+ '\r\n');


                            }


                        },1)
                    };

        });





    });
</script>
</body>
</html>
